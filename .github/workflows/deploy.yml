name: Deploy CBSP Plugin in WordPress SVN

on:
  workflow_dispatch:
  workflow_call:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PLUGIN_SLUG: choose-your-best-selling-products
      ZIP_FILE: choose-your-best-selling-products.zip
      DISTIGNORE: .distignore

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Create plugin zip from root using .distignore
        run: |
          zip -r ${{ env.ZIP_FILE }} . -x@${{ env.DISTIGNORE }}

      - name: Extract plugin zip
        run: |
          unzip -q ${{ env.ZIP_FILE }} -d extracted
          echo "Extracted files:"
          find extracted -type f

      - name: Compare extracted files with .distignore
        id: validate
        run: |
          # Normalize extracted file list
          find extracted -type f | sed 's|^extracted/|./|' | sort > extracted_files.txt

          # Normalize expected file list
          mkdir expected
          rsync -a --exclude-from=${{ env.DISTIGNORE }} ./ expected/
          find expected -type f | sed 's|^expected/|./|' | sort > expected_files.txt

          # Diff
          echo "Comparing extracted vs expected files..."
          diff expected_files.txt extracted_files.txt > diff.txt || true

          if [ -s diff.txt ]; then
            echo "unexpected_files=true" >> $GITHUB_OUTPUT
            echo "DIFF_OUTPUT<<EOF" >> $GITHUB_OUTPUT
            cat diff.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Unexpected files detected:"
            cat diff.txt
          else
            echo "unexpected_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Email - Unexpected Files Found
        if: steps.validate.outputs.unexpected_files == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[‚ùå Deployment Alert] Unexpected Files Detected in Plugin Package"
          to: veeraj11yadav@gmail.com
          from: CBSP Plugin Bot <no-reply@email.com>
          body: |
            Hello üëã

            ‚ùå The deployment was aborted due to **unexpected files** found in the plugin package.

            üì¶ Unexpected Files:
            ----------------------------------
            ${{ steps.validate.outputs.DIFF_OUTPUT }}

            ‚úÖ Please review and update your `.distignore` if needed.

            ‚Äì CBSP Deploy Bot

      - name: Exit on Unexpected Files
        if: steps.validate.outputs.unexpected_files == 'true'
        run: exit 1

      - name: SVN Checkout
        run: |
          svn checkout https://plugins.svn.wordpress.org/${{ env.PLUGIN_SLUG }}/ svn_repo

      - name: Copy Files to SVN Trunk
        run: |
          rsync -av extracted/ svn_repo/trunk/

      - name: SVN Commit
        run: |
          cd svn_repo
          svn add --force trunk/* --auto-props --parents --depth infinity -q
          svn commit -m "‚úÖ Deploying latest version of ${{ env.PLUGIN_SLUG }} plugin"

      - name: Send Email - Deployment Successful
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[‚úÖ SUCCESS] CBSP Plugin Deployed to WordPress.org SVN"
          to: veeraj11yadav@gmail.com
          from: CBSP Plugin Bot <no-reply@email.com>
          body: |
            Hello üëã

            ‚úÖ The `choose-your-best-selling-products` plugin has been successfully deployed to the WordPress.org SVN repository.

            - Plugin zip passed integrity check
            - SVN trunk updated
            - Deployment complete

            Cheers,  
            CBSP Deploy Bot
