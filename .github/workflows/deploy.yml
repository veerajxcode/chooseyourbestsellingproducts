name: Deploy CBSP Plugin in WordPress SVN

on:
  workflow_dispatch:
  workflow_call:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PLUGIN_SLUG: choose-your-best-selling-products
      ZIP_FILE: choose-your-best-selling-products.zip
      DISTIGNORE: .distignore

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Create plugin zip from root using .distignore
        run: |
          zip -r ${{ env.ZIP_FILE }} . -x@${{ env.DISTIGNORE }}

      - name: Extract plugin zip
        run: |
          unzip -q ${{ env.ZIP_FILE }} -d extracted
          echo "Extracted files:"
          find extracted -type f

      - name: Compare extracted files with .distignore
        id: validate
        run: |
          cd extracted
          # List all files in the extracted directory
          find . -type f | sort > ../extracted_files.txt
          cd ..
          # List all files in the current directory excluding those in .distignore
          rsync -av --exclude-from=${{ env.DISTIGNORE }} ./ temp_dir
          cd temp_dir
          find . -type f | sort > ../expected_files.txt
          cd ..
          # Compare the two file lists to find unexpected files
          diff extracted_files.txt expected_files.txt > diff.txt || true
          if [ -s diff.txt ]; then
            echo "unexpected_files=true" >> $GITHUB_OUTPUT
            echo "Unexpected files found:"
            cat diff.txt
          else
            echo "unexpected_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Email - Unexpected Files Found
        if: steps.validate.outputs.unexpected_files == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[❌ Deployment Alert] Unexpected Files Detected in Plugin Package"
          to: veeraj11yadav@gmail.com
          from: CBSP Plugin Bot <no-reply@email.com>
          body: |
            Hello,

            The deployment process for the `choose-your-best-selling-products` plugin has been halted due to the detection of unexpected files in the plugin package.

            Please review the differences below:

            $(cat diff.txt)

            Regards,
            CBSP Plugin Bot

      - name: Exit on Unexpected Files
        if: steps.validate.outputs.unexpected_files == 'true'
        run: exit 1

      - name: SVN Checkout
        run: |
          svn checkout https://plugins.svn.wordpress.org/${{ env.PLUGIN_SLUG }}/ svn_repo

      - name: Copy Files to SVN Trunk
        run: |
          rsync -av extracted/ svn_repo/trunk/

      - name: SVN Commit
        run: |
          cd svn_repo
          svn add --force trunk/*
          svn commit -m "Deploying new version of ${{ env.PLUGIN_SLUG }} plugin"

      - name: Send Email - Deployment Successful
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[✅ Deployment Success] Plugin Deployed to WordPress.org SVN"
          to: veeraj11yadav@gmail.com
          from: CBSP Plugin Bot <no-reply@email.com>
          body: |
            Hello,

            The `choose-your-best-selling-products` plugin has been successfully deployed to the WordPress.org SVN repository.

            Regards,
            CBSP Plugin Bot
