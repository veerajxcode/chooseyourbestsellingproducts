name: Deploy CBSP Plugin to WordPress SVN

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
      SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
      PLUGIN_SLUG: choose-your-best-selling-products
      SVN_URL: https://plugins.svn.wordpress.org/choose-your-best-selling-products/

    steps:
      - name: Checkout plugin code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Get plugin version
        id: plugin_version
        run: |
          version=$(grep -i "Version:" ${{ env.PLUGIN_SLUG }}.php | cut -d ':' -f2 | xargs)
          echo "Plugin version: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Install Subversion
        run: sudo apt-get update && sudo apt-get install -y subversion

      - name: Checkout SVN repo
        run: |
          svn checkout --username ${{ env.SVN_USERNAME }} --password ${{ env.SVN_PASSWORD }} --non-interactive ${{ env.SVN_URL }} svn

      - name: Backup current trunk (for rollback)
        run: cp -r svn/trunk svn/_trunk_backup

      - name: Clean trunk (preserve .svn)
        run: |
          find svn/trunk -mindepth 1 -not -name '.svn' -exec rm -rf {} +

      - name: Sync plugin to trunk (safely)
        run: |
          rsync -av --delete --exclude-from=.distignore --exclude='.svn/' ./ svn/trunk/

      - name: Create new tag if version is not tagged
        run: |
          if ! svn ls ${{ env.SVN_URL }}tags/${{ steps.plugin_version.outputs.version }} > /dev/null 2>&1; then
            svn cp svn/trunk svn/tags/${{ steps.plugin_version.outputs.version }}
          else
            echo "Tag already exists. Skipping tag creation."
          fi

      - name: SVN Commit
        run: |
          cd svn
          svn add --force . --auto-props --parents --depth infinity -q
          svn status
          svn commit -m "Deploy version ${{ steps.plugin_version.outputs.version }} (GitHub Run #${{ github.run_number }})" --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --non-interactive || {
            echo "âŒ Commit failed. Rolling back trunk..."
            svn revert -R .
            rm -rf trunk
            cp -r _trunk_backup trunk
            exit 1
          }

      - name: Cleanup backup (optional)
        if: success()
        run: rm -rf svn/_trunk_backup

      - name: âœ… Done
        run: echo "ğŸ‰ Successfully deployed version ${{ steps.plugin_version.outputs.version }}!"
