jobs:
  deploy-to-svn:
    name: Deploy Plugin to SVN
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Create production zip from .distignore
        run: zip -r cbsp.zip . -x@.distignore

      - name: Extract zip contents
        run: unzip cbsp.zip -d plugin-files

      - name: Validate extracted plugin files
        id: validate
        run: |
          echo "ðŸ§ª Validating extracted plugin structure..."
          cd plugin-files
          ALLOWED=("choose-your-best-selling-products.php" "assets" "includes" "vendor" "README.txt")
          UNEXPECTED=()
          for item in *; do
            if [[ ! " ${ALLOWED[*]} " =~ " $item " ]]; then
              UNEXPECTED+=("$item")
            fi
          done
          if [ ${#UNEXPECTED[@]} -ne 0 ]; then
            echo "Unexpected files detected:"
            printf '%s\n' "${UNEXPECTED[@]}"
            exit 1
          fi

      - name: Install Subversion (SVN)
        run: sudo apt-get update && sudo apt-get install -y subversion

      - name: Checkout SVN repository
        env:
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
        run: |
          svn co https://plugins.svn.wordpress.org/choose-your-best-selling-products svn-checkout \
            --username "$SVN_USERNAME" --password "$SVN_PASSWORD" \
            --non-interactive --trust-server-cert