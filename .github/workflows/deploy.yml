name: Deploy CBSP Plugin (SVN Dry Run)

on:
  workflow_dispatch:

jobs:
  svn-dry-run:
    runs-on: ubuntu-latest

    env:
      PLUGIN_SLUG: choose-your-best-selling-products
      SVN_URL: https://plugins.svn.wordpress.org/choose-your-best-selling-products/

    steps:
      - name: Checkout plugin code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Get plugin version
        id: plugin_version
        run: |
          version=$(grep -i "Version:" ${{ env.PLUGIN_SLUG }}.php | cut -d ':' -f2 | xargs)
          echo "Plugin version: $version"
          echo "version=$version" >> $GITHUB_OUTPUT
      
      - name: Install Subversion
        run: sudo apt-get update && sudo apt-get install -y subversion

      - name: Checkout SVN repo (read-only dry run)
        run: |
          svn checkout --depth=immediates ${{ env.SVN_URL }} svn
          cd svn
          svn update trunk tags

      - name: Prepare trunk folder with latest plugin files
        run: |
          rm -rf svn/trunk/*
          rsync -av --exclude-from=.distignore ./ svn/trunk/

      - name: Show prepared trunk structure
        run: |
          echo "ðŸ“‚ Updated trunk/ contents:"
          find svn/trunk

      - name: Upload trunk folder as artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: choose-your-best-selling-products
          path: svn/trunk