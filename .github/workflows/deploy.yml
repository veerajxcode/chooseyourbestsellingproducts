name: Deploy CBSP Plugin to WordPress SVN

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
      SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
      PLUGIN_SLUG: choose-your-best-selling-products

    steps:
      - name: Checkout plugin code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Get plugin version
        id: plugin_version
        run: |
          version=$(grep -i "Version:" ${{ env.PLUGIN_SLUG }}.php | cut -d ':' -f2 | xargs)
          echo "Plugin version: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Checkout SVN repo
        run: |
          svn checkout --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --non-interactive https://plugins.svn.wordpress.org/${{ env.PLUGIN_SLUG }}/ svn

      - name: Sync plugin to trunk
        run: |
          rsync -av --delete --exclude-from=.distignore ./ svn/${{ env.PLUGIN_SLUG }}/trunk

      - name: Create new tag if version is not tagged
        run: |
          if ! svn ls https://plugins.svn.wordpress.org/${{ env.PLUGIN_SLUG }}/tags/${{ steps.plugin_version.outputs.version }} > /dev/null 2>&1; then
            svn cp svn/${{ env.PLUGIN_SLUG }}/trunk svn/${{ env.PLUGIN_SLUG }}/tags/${{ steps.plugin_version.outputs.version }}
          else
            echo "Tag already exists. Skipping tag creation."
          fi

      - name: SVN Commit
        run: |
          cd svn/${{ env.PLUGIN_SLUG }}
          svn add --force * --auto-props --parents --depth infinity -q
          svn status
          svn commit -m "Deploy version ${{ steps.plugin_version.outputs.version }}" --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --non-interactive || {
            echo "‚ùå Commit failed. Rolling back trunk from tag..."
            rm -rf trunk
            svn cp https://plugins.svn.wordpress.org/${{ env.PLUGIN_SLUG }}/tags/${{ steps.plugin_version.outputs.version }} trunk
            svn update
            exit 1
          }

      - name: ‚úÖ Done
        run: echo "üéâ Successfully deployed version ${{ steps.plugin_version.outputs.version }}!"
