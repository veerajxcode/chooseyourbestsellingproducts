name: Deploy CBSP Plugin in WordPress SVN

on:
  workflow_dispatch:
  workflow_call:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PLUGIN_SLUG: choose-your-best-selling-products
      ZIP_FILE: choose-your-best-selling-products.zip
      DISTIGNORE: .distignore

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Create plugin zip from root using .distignore
        run: |
          zip -r ${{ env.ZIP_FILE }} . -x@${{ env.DISTIGNORE }}

      - name: Extract plugin zip
        run: |
          unzip -q ${{ env.ZIP_FILE }} -d extracted

      - name: Normalize and compare extracted files
        id: validate
        run: |
          # Normalize extracted file list (remove extracted/ prefix)
          cd extracted
          find . -type f | sort > ../extracted_files.txt
          cd ..

          # Create expected folder using distignore
          mkdir expected
          rsync -a --exclude-from=${{ env.DISTIGNORE }} ./ expected/
          cd expected
          find . -type f | sort > ../expected_files.txt
          cd ..

          # Compare extracted vs expected
          echo "Comparing extracted vs expected files..."
          diff expected_files.txt extracted_files.txt > diff.txt || true

          if [ -s diff.txt ]; then
            echo "unexpected_files=true" >> $GITHUB_OUTPUT
            echo "DIFF_OUTPUT<<EOF" >> $GITHUB_OUTPUT
            cat diff.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "‚ùå Unexpected files detected:"
            cat diff.txt
          else
            echo "unexpected_files=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No unexpected files."
          fi

      - name: Send Email - Unexpected Files Found
        if: steps.validate.outputs.unexpected_files == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[‚ùå Deployment Alert] Unexpected Files Detected in Plugin Package"
          to: veeraj11yadav@gmail.com
          from: CBSP Plugin Bot <no-reply@email.com>
          body: |
            Hello üëã

            The deployment was aborted due to **unexpected files** in your plugin zip.

            üì¶ Files not expected based on .distignore:
            -------------------------------------------
            ${{ steps.validate.outputs.DIFF_OUTPUT }}

            Please review or update your `.distignore` file if these files are intentional.

            ‚Äì CBSP Bot

      - name: Exit on Unexpected Files
        if: steps.validate.outputs.unexpected_files == 'true'
        run: exit 1

      - name: SVN Checkout
        run: |
          svn checkout https://plugins.svn.wordpress.org/${{ env.PLUGIN_SLUG }}/ svn_repo

      - name: Copy Files to SVN Trunk
        run: |
          rsync -av extracted/ svn_repo/trunk/

      - name: SVN Commit
        run: |
          cd svn_repo
          svn add --force trunk/*
          svn commit -m "Deploying new version of ${{ env.PLUGIN_SLUG }} plugin"

      - name: Send Email - Deployment Successful
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[‚úÖ Deployment Success] Plugin Deployed to WordPress.org SVN"
          to: veeraj11yadav@gmail.com
          from: CBSP Plugin Bot <no-reply@email.com>
          body: |
            Hello üëã

            ‚úÖ The `choose-your-best-selling-products` plugin has been **successfully deployed** to WordPress.org SVN.

            No unexpected files were found during the verification step.
            SVN trunk has been updated with your latest production-ready plugin files.

            ‚Äì CBSP Bot
