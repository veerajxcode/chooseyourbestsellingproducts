name: Deploy CBSP Plugin (Dry Run)

on:
  workflow_dispatch:
  workflow_call:

jobs:
  dry-run-svn:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Get plugin version
        id: plugin_version
        run: |
          version=$(grep -i "Version:" choose-your-best-selling-products.php | cut -d ':' -f2 | xargs)
          echo "Plugin version: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Prepare SVN trunk/ folder (dry run)
        run: |
          mkdir -p svn/choose-your-best-selling-products/trunk
          rsync -av --exclude-from=.distignore ./ svn/choose-your-best-selling-products/trunk

      - name: Preview trunk contents (dry run)
        run: |
          echo "Trunk contents:"
          find svn/choose-your-best-selling-products/trunk

      - name: Upload prepared trunk as artifact
        uses: actions/upload-artifact@v4
        with:
          name: cbsp-trunk-folder
          path: svn/choose-your-best-selling-products/trunk

      - name: Create GitHub Draft Release (dry run)
        uses: ncipollo/release-action@v1
        with:
          tag: dry-run-${{ github.run_number }}
          name: "CBSP Plugin SVN Dry Run - #${{ github.run_number }}"
          body: |
            ðŸ§ª This is a **dry run** of preparing SVN `trunk/` folder for deploy.

            âœ… Version: `${{ steps.plugin_version.outputs.version }}`
            âœ… Files filtered using `.distignore`
            ðŸ“‚ Plugin files prepared in `svn/choose-your-best-selling-products/trunk/`

            No push/commit has been made to the WordPress.org SVN repo.

            Please review the GitHub artifact: **cbsp-trunk-folder**
          draft: true
          token: ${{ secrets.DEPLOY_PAT }}
