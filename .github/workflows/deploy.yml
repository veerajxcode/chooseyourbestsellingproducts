name: Deploy CBSP Plugin (SVN Dry Run)

on:
  workflow_dispatch:

jobs:
  svn-dry-run:
    runs-on: ubuntu-latest

    env:
      PLUGIN_SLUG: choose-your-best-selling-products
      SVN_URL: https://plugins.svn.wordpress.org/choose-your-best-selling-products/

    steps:
      - name: Checkout plugin code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Get plugin version
        id: plugin_version
        run: |
          version=$(grep -i "Version:" ${{ env.PLUGIN_SLUG }}.php | cut -d ':' -f2 | xargs)
          echo "Plugin version: $version"
          echo "version=$version" >> $GITHUB_OUTPUT
      
      - name: Install Subversion
        run: sudo apt-get update && sudo apt-get install -y subversion

      - name: Checkout SVN repo (read-only dry run)
        run: |
          svn checkout --depth=immediates ${{ env.SVN_URL }} svn
          cd svn
          svn update trunk tags

      - name: Prepare trunk folder with latest plugin files
        run: |
          rm -rf svn/trunk/*
          rsync -av --exclude-from=.distignore ./ svn/trunk/

      - name: Show prepared trunk structure
        run: |
          echo "üìÇ Updated trunk/ contents:"
          find svn/trunk

      - name: Upload trunk folder as artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: choose-your-best-selling-products
          path: svn/trunk
      
      - name: SVN status preview (dry-run)
        run: |
          svn status svn/trunk

      - name: Commit to SVN with rollback on failure
        run: |
          cd svn
          svn add trunk --force
          svn status
          svn commit -m "Deploy plugin version ${{ steps.plugin_version.outputs.version }}" \
            --username ${{ secrets.SVN_USERNAME }} \
            --password ${{ secrets.SVN_PASSWORD }} \
            --non-interactive || {
              echo "‚ùå Commit failed. Rolling back trunk from latest tag..."
              rm -rf trunk
              svn cp ${{ env.SVN_URL }}tags/${{ steps.plugin_version.outputs.version }} trunk
              svn update trunk
              echo "‚úÖ Rolled back trunk from tag version ${{ steps.plugin_version.outputs.version }}"
              exit 1
            }
